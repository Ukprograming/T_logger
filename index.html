<!-- FILE: ds18b20_webserial_logger.html -->
trimWindow(windowMs);


// CSV 用に ISO 時刻も保存
const iso = new Date(Date.now() - (performance.now() - tsPerf)).toISOString();
csvRows.push([iso, ...temps]);
}


async function readLoop() {
while (readLoopActive) {
const { value, done } = await reader.read();
if (done) break;
lineBuf += value;
let idx;
while ((idx = lineBuf.indexOf('\n')) >= 0) {
const line = lineBuf.slice(0, idx).replace(/\r$/, '');
lineBuf = lineBuf.slice(idx + 1);
if (!line) continue;
if (line.startsWith('#')) { parseHeaderLine(line); log(line); continue; }
parseDataLine(line);
}
}
}


// --------- UI handlers ---------
connectBtn.onclick = connect;


disconnectBtn.onclick = disconnect;


startBtn.onclick = async () => {
await sendLine(`RES ${resSel.value}`);
await sendLine(`PERIOD ${periodIn.value}`);
await sendLine('START');
running = true;
statusEl.textContent = '記録中';
log('# START');
};


stopBtn.onclick = async () => {
await sendLine('STOP');
running = false;
statusEl.textContent = '停止';
log('# STOP');
};


markBtn.onclick = () => {
const ts = new Date().toISOString();
log(`# MARK ${ts}`);
};


clearBtn.onclick = () => {
chart.data.datasets.forEach(ds => ds.data = []);
chart.update();
csvRows = [];
log('# Cleared');
};


downloadBtn.onclick = () => {
const header = ['timestamp_iso'];
for (let i = 0; i < chart.data.datasets.length; i++) header.push(`T${i}_C`);
const lines = [header.join(',')];
for (const row of csvRows) lines.push(row.join(','));
const blob = new Blob(["\uFEFF" + lines.join('\n')], { type: 'text/csv' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url; a.download = `ds18b20_log_${new Date().toISOString().replace(/[:.]/g,'-')}.csv`;
a.click();
URL.revokeObjectURL(url);
};


// ページ離脱時は安全に切断
window.addEventListener('beforeunload', async (e) => { try { await disconnect(); } catch {} });
</script>
</body>
</html>